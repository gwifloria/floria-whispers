


## 系统概述
这是一个将 Microsoft Outlook 邮件同步到本地 MongoDB 数据库的系统，支持按联系人过滤、仅同步标记邮件等功能。
## 架构图

```

┌─────────────────────────────────────────────────────────────────────┐

│ 前端 (Next.js) │

│ ┌─────────────────────────────────────────────────────────────┐ │

│ │ /admin/mail-sync/page.tsx │ │

│ │ - 同步控制表单 (targetEmail, filterFlagged) │ │

│ │ - 同步历史列表 │ │

│ │ - 实时进度显示 │ │

│ │ - AuthModal 设备码认证弹窗 │ │

│ └─────────────────────────────────────────────────────────────┘ │

│ │ │

│ ▼ │

│ ┌─────────────────────────────────────────────────────────────┐ │

│ │ /api/admin/sync-mail (route.ts) │ │

│ │ - POST: 创建同步任务，启动后台同步 │ │

│ │ - GET: 查询任务状态和历史 │ │

│ │ - DELETE: 清空历史记录 │ │

│ └─────────────────────────────────────────────────────────────┘ │

│ │ │

│ ┌─────────────────────────────────────────────────────────────┐ │

│ │ /api/admin/clear-mail (route.ts) │ │

│ │ - POST: 清空所有邮件数据 + AuthCache │ │

│ └─────────────────────────────────────────────────────────────┘ │

└─────────────────────────────────────────────────────────────────────┘

│

▼

┌─────────────────────────────────────────────────────────────────────┐

│ @wonderland/mail-sync 包 │

│ ┌─────────────────────────────────────────────────────────────┐ │

│ │ mailSync.ts │ │

│ │ - runMailSyncWithProgress(options, callbacks) │ │

│ │ - 协调认证、获取、处理、保存四个阶段 │ │

│ │ - 处理内联图片上传到 Cloudinary │ │

│ └─────────────────────────────────────────────────────────────┘ │

│ │ │

│ ┌─────────────────────────────────────────────────────────────┐ │

│ │ graphClient.ts │ │

│ │ - getToken(): 设备码认证获取 access_token │ │

│ │ - fetchMessagesByContact(token, email, filterFlagged) │ │

│ │ - fetchAttachments(token, messageId) │ │

│ └─────────────────────────────────────────────────────────────┘ │

└─────────────────────────────────────────────────────────────────────┘

│

┌──────────────────┼──────────────────┐

▼ ▼ ▼

┌───────────────────┐ ┌───────────────────┐ ┌───────────────────┐

│ Microsoft Graph │ │ MongoDB │ │ Cloudinary │

│ API │ │ │ │ │

│ - /me/messages │ │ - Thread │ │ - mail-images/ │

│ - /attachments │ │ - MailMessage │ │ │

│ │ │ - SyncJob │ │ │

│ │ │ - AuthCache │ │ │

└───────────────────┘ └───────────────────┘ └───────────────────┘

```

  

## 数据流


### 1. 触发同步


```

用户点击「开始同步」

│

▼

POST /api/admin/sync-mail

│ body: { targetEmail, filterFlagged }

▼

创建 SyncJob (status: pending)

│

▼

启动后台任务 runSyncTask()

│

▼

返回 { jobId } 给前端

```

  

### 2. 认证流程 (设备码)


```

runMailSyncWithProgress()

│

▼

getToken() 检查 AuthCache

│

├─ 有有效 token → 直接使用

│

└─ 无 token 或已过期

│

▼

acquireTokenByDeviceCode()

│

▼

触发 onAuthRequired 回调

│

▼

SyncJob.authInfo = { userCode, verificationUri, expiresAt }

│

▼

前端轮询检测到 authInfo → 显示 AuthModal

│

▼

用户在浏览器完成认证

│

▼

token 缓存到 AuthCache

```

  

### 3. 邮件获取与过滤

  

```

fetchMessagesByContact(token, targetEmail, filterFlagged)

│

├─ filterFlagged = false

│ │

│ ▼

│ GET /me/messages?$filter=isDraft eq false

│ │

│ ▼

│ 客户端过滤: matchesTarget(msg, targetEmail)

│ (检查 from/to/cc 是否包含 targetEmail)

│

└─ filterFlagged = true

│

▼

GET /me/mailFolders/{Inbox,SentItems}/messages

?$filter=flag/flagStatus eq 'flagged'

│

▼

获取 flagged 邮件的 conversationId

│

▼

扩展获取完整对话

│

▼

客户端过滤: matchesTarget()

```

  

### 4. 数据处理与存储

  

```

邮件列表

│

▼

groupByConversation() - 按 conversationId 分组

│

▼

upsertToMongo()

│

├─ 每个对话 → Thread 文档

│ { _id: conversationId, subject, participants, messageCount }

│

└─ 每封邮件 → MailMessage 文档

│

├─ 处理 cid: 内联图片 → 上传 Cloudinary

│

├─ splitEmailParts() - 分离正文和引用

│

└─ { _id: msgId, threadId, from, to, htmlClean, quotedHtml }

```

  

## 关键文件

  

| 文件路径 | 职责 |

|---------|------|

| `apps/web/src/app/admin/mail-sync/page.tsx` | 同步管理 UI |

| `apps/web/src/app/admin/mail-sync/AuthModal.tsx` | 设备码认证弹窗 |

| `apps/web/src/app/api/admin/sync-mail/route.ts` | 同步 API 端点 |

| `apps/web/src/app/api/admin/clear-mail/route.ts` | 清空数据 API |

| `apps/web/src/app/api/models/SyncJob.ts` | 同步任务模型 |

| `packages/mail-sync/src/mailSync.ts` | 同步核心逻辑 |

| `packages/mail-sync/src/graphClient.ts` | Microsoft Graph 客户端 |

| `packages/database/src/models/Thread.ts` | 邮件线程模型 |

| `packages/database/src/models/MailMessage.ts` | 邮件消息模型 |

| `packages/database/src/models/AuthCache.ts` | 认证缓存模型 |

  

## 数据库模型

  

### SyncJob (同步任务)

```typescript

{

_id: ObjectId,

status: "pending" | "running" | "completed" | "failed",

options: { targetEmail?: string, filterFlagged: boolean },

progress: { stage, current, total, message },

authInfo?: { userCode, verificationUri, expiresAt },

result?: { threadsCount, messagesCount, imagesProcessed },

logs: string[],

startedAt: Date,

completedAt?: Date,

error?: string

}

```

  

### Thread (邮件线程)

```typescript

{

_id: conversationId,

subject: string,

participants: [{ name, address }],

firstAt: Date,

updatedAt: Date,

messageCount: number,

lastSyncAt: Date

}

```

  

### MailMessage (邮件消息)

```typescript

{

_id: graphMessageId,

messageId: sha1(internetMessageId + timestamp + from + subject),

threadId: conversationId,

from: { name, address },

to: [{ name, address }],

cc: [{ name, address }],

sentAt: Date,

subject: string,

htmlRaw: string, // 原始 HTML

htmlClean: string, // 清理后的正文

quotedHtml: string, // 引用部分

flagged: boolean,

attachments: []

}

```

  

### AuthCache (认证缓存)

```typescript

{

_id: "msal-cache",

cache: string // MSAL 序列化的 token 缓存

}

```

  

## 环境变量

  

```bash

# Microsoft OAuth (必需)

MS_CLIENT_ID=<Azure AD 应用 ID>

MS_AUTHORITY=https://login.microsoftonline.com/consumers

  

# MongoDB (必需)

MONGODB_URI=<连接字符串>

  

# Cloudinary (用于内联图片)

CLOUDINARY_CLOUD_NAME=<name>

CLOUDINARY_API_KEY=<key>

CLOUDINARY_API_SECRET=<secret>

```

  

## 前端展示

  

### Letters 列表页 `/letters`

- `LettersListClient.tsx` - 线程卡片列表

- 空数据时显示「暂无信件」

  

### Letters 详情页 `/letters/[threadId]`

- `LetterDetailClient.tsx` - 邮件详情

- `MailComment.tsx` - 评论功能