# é¡¹ç›®ä¼˜åŒ–æ—¥å¿— - 10.14

## ğŸš¨ ç´§æ€¥ä¼˜åŒ–é¡¹

### 1. æ„å»ºäº§ç‰©è¿‡å¤§ (1.3GB)

**é—®é¢˜**: `.next` ç›®å½•å ç”¨ 1.3GBï¼Œå¯èƒ½åŒ…å«å¤§é‡æœªä¼˜åŒ–èµ„æº

**å»ºè®®**:
```bash
# åˆ†ææ‰“åŒ…ä½“ç§¯
ANALYZE=true yarn build

# æ£€æŸ¥æ˜¯å¦éœ€è¦æ¸…ç†ç¼“å­˜
yarn clean
```

**ä¼˜åŒ–æ–¹å‘**:
- å¯ç”¨ Tree Shaking å’Œ Code Splitting
- æ£€æŸ¥æ˜¯å¦æœ‰ä¸å¿…è¦çš„ä¾èµ–è¢«æ‰“åŒ…
- è€ƒè™‘ä½¿ç”¨åŠ¨æ€å¯¼å…¥ `next/dynamic` å»¶è¿ŸåŠ è½½é‡ç»„ä»¶ï¼ˆThree.js, TipTap ç­‰ï¼‰

### 2. React Strict Mode å·²å…³é—­

**å½“å‰çŠ¶æ€**: `reactStrictMode: false` (next.config.mjs:56)

**é£é™©**: å¯èƒ½éšè—æ½œåœ¨é—®é¢˜ï¼Œä¸åˆ©äºå‡çº§åˆ° React 19

**å»ºè®®**: é€æ­¥å¯ç”¨å¹¶ä¿®å¤è­¦å‘Š
#### ğŸ“š ä»€ä¹ˆæ˜¯ React Strict Modeï¼Ÿ

  React Strict Mode æ˜¯ React
  çš„å¼€å‘æ¨¡å¼å·¥å…·ï¼Œç”¨æ¥å¸®åŠ©å‘ç°åº”ç”¨ä¸­çš„æ½œåœ¨é—®é¢˜ã€‚å®ƒä¸ä¼šæ¸²æŸ“ä»»ä½•å¯è§çš„
  UIï¼Œä½†ä¼šä¸ºå…¶åä»£å…ƒç´ è§¦å‘é¢å¤–çš„æ£€æŸ¥å’Œè­¦å‘Šã€‚

  æ ¸å¿ƒæœºåˆ¶

  åœ¨ Strict Mode ä¸‹ï¼ŒReact ä¼šæ•…æ„åŒé‡è°ƒç”¨æŸäº›å‡½æ•°æ¥å¸®ä½ å‘ç°å‰¯ä½œç”¨é—®é¢˜ï¼š

  // åœ¨ Strict Mode ä¸‹ï¼Œè¿™äº›ä¼šè¢«è°ƒç”¨ä¸¤æ¬¡
  useEffect(() => {
    console.log("mounted");  // å¼€å‘æ¨¡å¼ä¸‹ä¼šæ‰“å°ä¸¤æ¬¡
    fetchData();              // âš ï¸ å¯èƒ½å¯¼è‡´é‡å¤è¯·æ±‚
  }, []);

  ---
  ğŸ” ä½ çš„é¡¹ç›®æƒ…å†µ

  å½“å‰é…ç½®

  // next.config.mjs:56
  reactStrictMode: false  // âŒ å·²å…³é—­

  é¡¹ç›®ç¯å¢ƒ

  - React 19.0.0 - æœ€æ–°ç‰ˆæœ¬
  - 38 ä¸ª useEffect ä½¿ç”¨ - å¯èƒ½å­˜åœ¨å‰¯ä½œç”¨é—®é¢˜
  - ä½¿ç”¨äº† @ant-design/v5-patch-for-react-19 - è¯´æ˜åœ¨å¤„ç† React 19 å…¼å®¹æ€§

  ---
##### âš ï¸ å…³é—­ Strict Mode çš„é£é™©

  1. éšè— React 19 çš„ Breaking Changes

  React 19 å¼•å…¥äº†é‡å¤§å˜åŒ–ï¼ŒStrict Mode å¯ä»¥å¸®ä½ æå‰å‘ç°ï¼š

  // âŒ é—®é¢˜ä»£ç ï¼ˆåœ¨ Strict Mode ä¸‹ä¼šæš´éœ²ï¼‰
  useEffect(() => {
    const socket = new WebSocket('ws://...');
    // å¿˜è®°æ¸…ç†ï¼React 19 ä¸¥æ ¼æ¨¡å¼ä¼šè®©è¿™ä¸ªé—®é¢˜æ›´æ˜æ˜¾
  }, []);

  // âœ… æ­£ç¡®ä»£ç 
  useEffect(() => {
    const socket = new WebSocket('ws://...');
    return () => socket.close();  // æ¸…ç†å‡½æ•°
  }, []);

  2. å‰¯ä½œç”¨æœªæ¸…ç†

  ä½ çš„é¡¹ç›®æœ‰ 38 ä¸ª useEffectï¼Œå¯èƒ½å­˜åœ¨ï¼š
  - WebSocket è¿æ¥æœªå…³é—­
  - å®šæ—¶å™¨æœªæ¸…é™¤
  - äº‹ä»¶ç›‘å¬å™¨æœªç§»é™¤
  - ç½‘ç»œè¯·æ±‚æœªå–æ¶ˆ

  // ç¤ºä¾‹ï¼šä½ é¡¹ç›®ä¸­å¯èƒ½å­˜åœ¨çš„é—®é¢˜
  useEffect(() => {
    const interval = setInterval(() => {
      fetchData();  // âš ï¸ ç»„ä»¶å¸è½½åä»åœ¨æ‰§è¡Œ
    }, 1000);
    // ç¼ºå°‘æ¸…ç†ï¼
  }, []);

  3. ç¬¬ä¸‰æ–¹åº“å…¼å®¹æ€§é—®é¢˜

  ç‰¹åˆ«æ˜¯ï¼š
  - Ant Design 5 - ä½¿ç”¨äº† React 19 patch
  - TipTap - å¯Œæ–‡æœ¬ç¼–è¾‘å™¨å¯èƒ½æœ‰å‰¯ä½œç”¨
  - @ant-design/plots - å›¾è¡¨åº“å¯èƒ½æœ‰ DOM æ“ä½œ
  - Mapbox GL - åœ°å›¾åº“æœ‰å¤§é‡å‰¯ä½œç”¨

  ---
  ğŸ¯ ä¸ºä»€ä¹ˆé¡¹ç›®å…³é—­äº†å®ƒï¼Ÿ

  å¯èƒ½çš„åŸå› ï¼š

  1. ç¬¬ä¸‰æ–¹åº“ä¸å…¼å®¹
    - Ant Design åœ¨ React 19 ä¸‹å¯èƒ½æœ‰è­¦å‘Š
    - å›¾è¡¨ã€åœ°å›¾åº“åœ¨ Strict Mode ä¸‹ä¼šæŠ¥é”™
  2. å¼€å‘ä½“éªŒé—®é¢˜
    - Console è¾“å‡ºç¿»å€å¾ˆçƒ¦äºº
    - æŸäº›å‰¯ä½œç”¨è¢«è§¦å‘ä¸¤æ¬¡å¯¼è‡´åŠŸèƒ½å¼‚å¸¸
  3. å†å²é—ç•™
    - é¡¹ç›®å‡çº§åˆ° React 19 æ—¶ä¸ºäº†å¿«é€Ÿä¸Šçº¿è€Œä¸´æ—¶å…³é—­

  ---
  ğŸ“‹ å¯ç”¨ Strict Mode çš„è®¡åˆ’

  é˜¶æ®µ 1ï¼šæ£€æµ‹é˜¶æ®µï¼ˆåªè§‚å¯Ÿï¼Œä¸ä¿®å¤ï¼‰

  ç›®æ ‡ï¼šçœ‹çœ‹ä¼šæœ‰ä»€ä¹ˆè­¦å‘Š

  4. å¯ç”¨ Strict Modeï¼š
  // next.config.mjs
  reactStrictMode: true  // âœ… æ”¹ä¸º true
  5. è¿è¡Œå¼€å‘æœåŠ¡å™¨ï¼Œè®°å½•æ‰€æœ‰è­¦å‘Š
  6. åˆ†ç±»é—®é¢˜ï¼š
    - ç¬¬ä¸‰æ–¹åº“é—®é¢˜ï¼ˆä¸åœ¨æ§åˆ¶èŒƒå›´ï¼‰
    - è‡ªå·±ä»£ç é—®é¢˜ï¼ˆéœ€è¦ä¿®å¤ï¼‰

  é˜¶æ®µ 2ï¼šä¿®å¤è‡ªæœ‰ä»£ç 

  é’ˆå¯¹ä½ çš„ 38 ä¸ª useEffectï¼Œæ£€æŸ¥ï¼š

  å¸¸è§é—®é¢˜æ¨¡å¼ï¼š

  // âŒ é—®é¢˜ 1ï¼šfetch æœªå–æ¶ˆ
  useEffect(() => {
    fetchData().then(setData);
  }, []);

  // âœ… ä¿®å¤
  useEffect(() => {
    let cancelled = false;
    fetchData().then(data => {
      if (!cancelled) setData(data);
    });
    return () => { cancelled = true; };
  }, []);

  // âŒ é—®é¢˜ 2ï¼šå®šæ—¶å™¨æœªæ¸…ç†
  useEffect(() => {
    const timer = setInterval(update, 1000);
  }, []);

  // âœ… ä¿®å¤
  useEffect(() => {
    const timer = setInterval(update, 1000);
    return () => clearInterval(timer);
  }, []);

  // âŒ é—®é¢˜ 3ï¼šäº‹ä»¶ç›‘å¬æœªç§»é™¤
  useEffect(() => {
    window.addEventListener('resize', handleResize);
  }, []);

  // âœ… ä¿®å¤
  useEffect(() => {
    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, []);

  é˜¶æ®µ 3ï¼šå¤„ç†ç¬¬ä¸‰æ–¹åº“

  å¯èƒ½éœ€è¦çš„ä¿®å¤ï¼š

  // Ant Design Plots - å¯èƒ½éœ€è¦åŒ…è£…
  const ChartWrapper = dynamic(
    () => import('./Chart'),
    { ssr: false }  // ç¦ç”¨ SSR æ¥é¿å…æŸäº›é—®é¢˜
  );

  // TipTap Editor - ç¡®ä¿æ¸…ç†
  useEffect(() => {
    const editor = new Editor({...});
    return () => editor.destroy();  // é‡è¦ï¼
  }, []);

  é˜¶æ®µ 4ï¼šæ¸è¿›å¼å¯ç”¨

  å¦‚æœå…¨å±€å¯ç”¨é—®é¢˜å¤ªå¤šï¼Œå¯ä»¥é¡µé¢çº§å¯ç”¨ï¼š

  // æŸä¸ªç¨³å®šé¡µé¢
  export default function StablePage() {
    return (
      <React.StrictMode>
        <YourComponent />
      </React.StrictMode>
    );
  }

  ---
  ğŸ å¯ç”¨åçš„å¥½å¤„

  7. æå‰å‘ç° Bug - åœ¨å¼€å‘é˜¶æ®µå°±å‘ç°å†…å­˜æ³„æ¼
  8. React 19 å…¼å®¹ - ç¡®ä¿æœªæ¥ React ç‰ˆæœ¬å‡çº§é¡ºåˆ©
  9. æ€§èƒ½ä¼˜åŒ– - æ¸…ç†å‰¯ä½œç”¨å¯ä»¥å‡å°‘å†…å­˜å ç”¨
  10. ä»£ç è´¨é‡ - å¼ºåˆ¶å†™å‡ºæ›´å¥å£®çš„ä»£ç 

  ---
  ğŸ’¡ æˆ‘çš„å»ºè®®

  ä¼˜å…ˆçº§ï¼šä¸­ç­‰

  - âœ… ç°åœ¨å¯ä»¥åšï¼šå…ˆè®°å½•åˆ° TODOï¼Œä¸ç€æ€¥ä¿®
  - â° å»ºè®®æ—¶æœºï¼šä¸‹æ¬¡å¤§ç‰ˆæœ¬è¿­ä»£æ—¶å†å¤„ç†
  - ğŸ¯ é¢„æœŸå·¥ä½œé‡ï¼šéœ€è¦ 2-3 å¤©é€ä¸ªæ£€æŸ¥ useEffect

  åŸå› ï¼š
  - é¡¹ç›®å·²ç»åœ¨ç”Ÿäº§ç¯å¢ƒç¨³å®šè¿è¡Œ
  - ä¸»è¦æ˜¯ä»£ç è´¨é‡é—®é¢˜ï¼Œä¸æ˜¯ç´§æ€¥ bug
  - ä½†é•¿æœŸæ¥çœ‹å¯¹ç»´æŠ¤æ€§æœ‰å¥½å¤„

### 3. ä¾èµ–è¿‡é‡

**é‡é‡çº§ä¾èµ–éœ€è¦ä¼˜åŒ–åŠ è½½**:
- `three` + `@react-three/fiber` - 3D æ¸²æŸ“åº“
- `@ant-design/plots` - å›¾è¡¨åº“
- `@tiptap/*` - å¯Œæ–‡æœ¬ç¼–è¾‘å™¨
- `mapbox-gl` - åœ°å›¾åº“

**å»ºè®®**:
```javascript
// ä½¿ç”¨åŠ¨æ€å¯¼å…¥
const Scene3D = dynamic(() => import('@/components/Scene3D'), {
  ssr: false,
  loading: () => <LoadingSpinner />
})

const TipTapEditor = dynamic(() => import('@/components/Editor'), {
  ssr: false
})
```

---

## ğŸ”§ æ¶æ„ä¼˜åŒ–


### 5. Vercel æ„å»ºé…ç½®å¯ä¼˜åŒ–

**å½“å‰é…ç½®** (vercel.json):
```json
{
  "buildCommand": "yarn workspaces foreach -Apt --include '@wonderland/{database,shared}' run build && yarn build:web"
}
```

**é—®é¢˜**: å¦‚æœå®é™…æ²¡æœ‰ workspaceï¼Œè¿™ä¸ªå‘½ä»¤å¯èƒ½æœ‰é—®é¢˜

**å»ºè®®**: æ ¹æ®å®é™…ç»“æ„è°ƒæ•´æ„å»ºå‘½ä»¤

---

## âš¡ æ€§èƒ½ä¼˜åŒ–

### 6. å›¾ç‰‡ä¼˜åŒ–

**ä¼˜ç‚¹**: å·²é…ç½® AVIF + WebP (next.config.mjs:71)

**å»ºè®®**:
- æ£€æŸ¥ `public/` ç›®å½•å›¾ç‰‡æ˜¯å¦éƒ½å·²ä¼˜åŒ–
- è¿è¡Œ `yarn img:opt` ä¼˜åŒ–å›¾ç‰‡
- è€ƒè™‘ä½¿ç”¨ Cloudinary çš„è‡ªåŠ¨ä¼˜åŒ–åŠŸèƒ½

### 7. API è·¯ç”±æ€§èƒ½

```bash
# æ£€æŸ¥ API è·¯ç”±æ•°é‡
find src/app/api -name "route.ts" | wc -l
```

**å»ºè®®**:
- ä¸ºé¢‘ç¹è®¿é—®çš„ API æ·»åŠ ç¼“å­˜ç­–ç•¥
- ä½¿ç”¨ Next.js 15 çš„ `unstable_cache` æˆ– Redis
- è€ƒè™‘ä¸º `/api/posts/list` ç­‰åˆ—è¡¨æ¥å£æ·»åŠ åˆ†é¡µå’Œç¼“å­˜

### 8. æ•°æ®åº“è¿æ¥ä¼˜åŒ–

**æ£€æŸ¥ç‚¹**: MongoDB è¿æ¥æ± é…ç½®

**å»ºè®®**: æŸ¥çœ‹ `@wonderland/database` åŒ…çš„è¿æ¥ç®¡ç†ï¼Œç¡®ä¿ä½¿ç”¨è¿æ¥æ± 

---

## ğŸ›¡ï¸ ä»£ç è´¨é‡

### 9. TypeScript ä¸¥æ ¼æ¨¡å¼

æ£€æŸ¥ tsconfig.json:
```json
{
  "compilerOptions": {
    "strict": true,
    "noUncheckedIndexedAccess": true
  }
}
```

### 10. æµ‹è¯•è¦†ç›–ç‡

**å½“å‰**: é…ç½®äº† Jest + Playwright

**å»ºè®®**:
- ä¸ºæ ¸å¿ƒåŠŸèƒ½æ·»åŠ å•å…ƒæµ‹è¯•
- ä¸ºå…³é”®ç”¨æˆ·æµç¨‹æ·»åŠ  E2E æµ‹è¯•
- è®¾ç½®æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡

---

## ğŸ”’ å®‰å…¨æ€§

### 11. ç¯å¢ƒå˜é‡éªŒè¯

**ä¼˜ç‚¹**: å·²åœ¨ next.config.mjs ä¸­éªŒè¯å¿…éœ€çš„ç¯å¢ƒå˜é‡

**å»ºè®®**:
- ä¸ºç”Ÿäº§ç¯å¢ƒæ·»åŠ æ›´å¤šéªŒè¯
- ä½¿ç”¨ zod æˆ–ç±»ä¼¼åº“éªŒè¯ç¯å¢ƒå˜é‡æ ¼å¼

### 12. Admin è·¯ç”±ä¿æŠ¤

**æ£€æŸ¥**: `/admin/monitoring` éœ€è¦ç¡®ä¿æœ‰èº«ä»½éªŒè¯

**å»ºè®®**: ä½¿ç”¨ NextAuth middleware ä¿æŠ¤æ•æ„Ÿè·¯ç”±

---

## ğŸ“Š ç›‘æ§ä¼˜åŒ–

### 13. Sentry é…ç½®

**å½“å‰**: å·²é…ç½® Sentry

**å»ºè®®**:
- æ£€æŸ¥ source maps ä¸Šä¼ 
- è®¾ç½®åˆç†çš„é‡‡æ ·ç‡
- é…ç½® Performance Monitoring

### 14. Web Vitals

**å·²æœ‰**: æ€§èƒ½ç›‘æ§é¢æ¿

**å»ºè®®**:
- è®¾ç½®æ€§èƒ½é¢„ç®—å’Œå‘Šè­¦
- å®šæœŸæŸ¥çœ‹æ€§èƒ½æŠ¥å‘Š
- ä¼˜åŒ– LCP, FID, CLS æŒ‡æ ‡

---

## ğŸ§¹ æ¸…ç†å»ºè®®

### 15. ä¾èµ–æ¸…ç†

```bash
# æ£€æŸ¥æœªä½¿ç”¨çš„ä¾èµ–
npx depcheck

# æ£€æŸ¥è¿‡æ—¶çš„ä¾èµ–
yarn outdated
```

### 16. ä»£ç æ¸…ç†

- ç§»é™¤æœªä½¿ç”¨çš„ç»„ä»¶å’Œæ ·å¼
- ç»Ÿä¸€æ ·å¼æ–¹æ¡ˆï¼ˆå½“å‰æ··ç”¨ Tailwind + SCSS + Ant Designï¼‰
- æ¸…ç† console.logï¼ˆå·²æœ‰ `clean:console` è„šæœ¬ï¼‰
