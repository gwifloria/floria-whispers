## **1. ä¸ºä»€ä¹ˆéœ€è¦ useState**

- å‡½æ•°ç»„ä»¶æ¯æ¬¡æ¸²æŸ“éƒ½ä¼šé‡æ–°æ‰§è¡Œï¼Œæ™®é€šå˜é‡æ— æ³•â€œè®°ä½â€ä¸Šä¸€æ¬¡çš„å€¼ã€‚
- useState æä¾›äº†ä¸€ä¸ª **çŠ¶æ€å­˜å‚¨æœºåˆ¶ + è§¦å‘æ›´æ–°æœºåˆ¶**ã€‚

## **2. æ ¸å¿ƒå®ç°æ€è·¯**

- **å­˜å‚¨çŠ¶æ€**ï¼šç”¨æ•°ç»„å­˜æ”¾æ¯ä¸ªç»„ä»¶çš„ stateã€‚
- **å®šä½çŠ¶æ€**ï¼šç”¨ä¸€ä¸ªå…¨å±€ç´¢å¼• indexï¼Œæ¯æ¬¡è°ƒç”¨ä¸€ä¸ª hookï¼Œå°±å»å¯¹åº”ä½ç½®å–å€¼ã€‚
- **æ›´æ–°çŠ¶æ€**ï¼šsetState æ›´æ–°æ•°ç»„é‡Œçš„å€¼ï¼Œç„¶åè§¦å‘ç»„ä»¶é‡æ–°æ¸²æŸ“
## **3. ä¸ºä»€ä¹ˆ hooks ä¸èƒ½å†™åœ¨æ¡ä»¶è¯­å¥é‡Œ**

å› ä¸º React æ˜¯é â€œè°ƒç”¨é¡ºåºâ€æ¥ç¡®å®šæ¯ä¸ª hook å¯¹åº”å“ªä¸ª state çš„ï¼Œ
ä¸€æ—¦æ¡ä»¶åˆ†æ”¯å¯¼è‡´è°ƒç”¨æ¬¡æ•°ä¸ä¸€è‡´ï¼Œæ•´ä¸ªé“¾è¡¨å°±ä¹±äº†ã€‚

## **4. setState æ˜¯å¦æ˜¯å¼‚æ­¥ï¼Ÿ**
### **è¡¨ç°å±‚é¢**
- ä»å¼€å‘è€…è§’åº¦çœ‹ï¼Œè°ƒç”¨ setState åï¼Œ**state ä¸ä¼šç«‹åˆ»æ›´æ–°åˆ°æœ€æ–°å€¼**ï¼Œè€Œæ˜¯è¦ç­‰åˆ° React è°ƒåº¦ä¸€æ¬¡æ¸²æŸ“ä¹‹åæ‰ç”Ÿæ•ˆã€‚
- æ‰€ä»¥æˆ‘ä»¬å¸¸è¯´å®ƒæ˜¯â€œå¼‚æ­¥çš„â€ã€‚
- React å¹¶ä¸æ˜¯é©¬ä¸Šæ›´æ–°ï¼Œè€Œæ˜¯æŠŠæ›´æ–°æ”¾è¿›é˜Ÿåˆ—ï¼Œç­‰å¾…è°ƒåº¦ã€‚    
    - å¥½å¤„ï¼šå¯ä»¥åˆå¹¶å¤šæ¬¡æ›´æ–°ï¼ˆbatchingï¼‰ï¼Œæé«˜æ€§èƒ½ã€‚
### **å®ç°åŸç†**
ä¸¥æ ¼æ¥è¯´ï¼Œ**React å†…éƒ¨ setState å¹¶ä¸æ˜¯ç›´æ¥ç”¨å¼‚æ­¥ APIï¼ˆæ¯”å¦‚ setTimeoutï¼‰æ¥å®ç°çš„**ã€‚
è°ƒç”¨ setState æ—¶ï¼ŒReact ä¼šï¼š
1. **åˆ›å»ºä¸€ä¸ªæ›´æ–°å¯¹è±¡**ï¼ˆupdateï¼‰ï¼Œå­˜åˆ°è¯¥ hook å¯¹åº”çš„é˜Ÿåˆ—é‡Œã€‚
2. **æ ‡è®° Fiber æ ‘éœ€è¦æ›´æ–°**ã€‚
3. **äº¤ç»™è°ƒåº¦å™¨ï¼ˆSchedulerï¼‰åœ¨åˆé€‚æ—¶æœºç»Ÿä¸€æ‰§è¡Œæ›´æ–°**ã€‚
è¿™ä¸ªâ€œåˆé€‚æ—¶æœºâ€å¯èƒ½æ˜¯ï¼š
- åŒä¸€ä¸ªäº‹ä»¶å¾ªç¯ï¼ˆå¦‚æœåœ¨ React æ§åˆ¶çš„äº‹ä»¶é‡Œï¼ŒReact ä¼šæ‰¹é‡åˆå¹¶ï¼‰ã€‚
- ä¸‹ä¸€ä¸ªäº‹ä»¶å¾ªç¯ï¼ˆå¦‚æœ React åˆ¤æ–­éœ€è¦å»¶è¿Ÿï¼‰ã€‚

ğŸ‘‰ å› æ­¤ï¼Œæœ¬è´¨ä¸Šæ˜¯ **â€œå»¶è¿Ÿç”Ÿæ•ˆçš„åŒæ­¥æ“ä½œâ€**ï¼ŒReact è‡ªå·±åšäº†è°ƒåº¦ï¼Œçœ‹èµ·æ¥å°±åƒå¼‚æ­¥ã€‚

```javascript
let hookStates = [];
let hookIndex = 0;
let isScheduled = false;

export function useState(initial) {
  const i = hookIndex++;
  hookStates[i] = hookStates[i] ?? initial;

  const setState = (v) => {
    hookStates[i] = typeof v === "function" ? v(hookStates[i]) : v;
    scheduleUpdate();
  };
  return [hookStates[i], setState];
}

function scheduleUpdate() {
  if (isScheduled) return;
  isScheduled = true;
  queueMicrotask(() => { // ç”¨å¾®ä»»åŠ¡æ¨¡æ‹Ÿä¸€æ¬¡â€œè‡ªåŠ¨æ‰¹å¤„ç†â€
    isScheduled = false;
    rerender();
  });
}

export function render(Component) {
  hookIndex = 0;
  Component();
}

// ç¤ºä¾‹
function App() {
  const [a, setA] = useState(0);
  const [b, setB] = useState(0);
  console.log("render:", a, b);

  // åŒä¸€è½®é‡Œå¤šæ¬¡æ›´æ–°ï¼Œåªè§¦å‘ä¸€æ¬¡ render
  if (a === 0 && b === 0) {
    setA((x) => x + 1);
    setB((y) => y + 1);
  }
}
function rerender() { render(App); }
render(App);
```