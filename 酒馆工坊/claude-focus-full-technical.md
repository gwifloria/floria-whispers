# 利用 AI 辅助写代码的最大弊端：注意力的切换
## 一个自动化解决方案的思考与实践

---

## 问题的根源

我认为很多用 Claude Code 的人都遇到过这个问题：当 Claude 在处理问题时，我们可能会去做其他事情。当他在执行可能存在风险的操作前，会暂停工作并等待我们的许可——**我发现，这可能正是问题出现的时刻**。

具体来说，暂停点往往创造了一个"注意力真空"。在这个真空中，我有时候会上网冲浪，在互联网上寻求多巴胺刺激时，可能会被其内容深深吸引。这种低阻力、高奖励的内容（即时反馈、无需思考）的诱引力，往往远超 Claude 的计划或警告消息。结果就是，我快速浏览这些关键信息，甚至在没有仔细思考的情况下就按下了回车键。

后来，当我遇到 Claude 多次尝试但未能修复的 bug 时，真实的问题才显现出来：不仅是浪费的时间和 token，**更重要的是，开发过程中的势头被打破了**。

这种"势头断裂"的代价是隐形的但致命的。就像《刻意练习》中强调的那样，高效的学习需要集中注意力和连贯的反馈循环。一旦这个循环被打断，重新建立状态需要额外的认知成本。

---

## 我的解决方案：双维度自动日志系统

因此，我指导 Claude Code 编写了一个 Shell 脚本来自动化这个过程。这个脚本的核心理念很简单：**通过系统性地记录每一次交互，强制自己在暂停点保持对任务的连贯性**。

### 实现原理：利用 Claude Code 的 Hooks 生命周期

Claude Code 提供了一个 hooks 系统，在关键的生命周期事件中触发自定义脚本。我的日志系统就是基于两个核心事件构建的：

**① UserPromptSubmit 事件** —— 任务开始时
当用户提交 prompt 给 Claude 时触发，记录任务的初始状态。

**② Stop 事件** —— 任务完成时
当 Claude Code 停止执行时触发，自动提取 Claude 的最终回复并整理成结构化日志。

---

## 工作流程详解

### 整体流程图

```
┌─────────────────────────────────────────────────────────────┐
│  开发者打开 Claude Code，编写 prompt                          │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
        ┌──────────────────────────────┐
        │  UserPromptSubmit 事件触发    │
        │  (hook: logger_start)        │
        └──────────────┬───────────────┘
                       │
         ┌─────────────┴─────────────┐
         │ 解析输入 JSON             │
         │ - prompt 内容             │
         │ - session_id              │
         │ - project 信息            │
         └─────────────┬─────────────┘
                       │
         ┌─────────────┴─────────────────────────┐
         │ 生成任务开始记录                       │
         │ ┌─────────────────────────────────┐  │
         │ │ 时间戳：2024-01-15 10:30:45     │  │
         │ │ 会话ID：uuid-xxx                │  │
         │ │ 项目：RedNote                   │  │
         │ │ 任务：实现用户认证功能           │  │
         │ └─────────────────────────────────┘  │
         └──────┬──────────────────┬─────────────┘
                │                  │
        ┌──────▼────────┐  ┌─────▼──────────┐
        │ 写入今日日志  │  │ 写入项目日志    │
        │(按时间排序)   │  │(按项目分类)    │
        └──────────────┘  └────────────────┘
                │
                ▼
    Claude Code 执行过程中可能暂停
    (等待用户批准风险操作)
    ← 注意力真空 ← 用户容易分心的地方
                │
                ▼
        ┌──────────────────────────────┐
        │  Stop 事件触发                │
        │  (hook: logger_complete)     │
        └──────────────┬───────────────┘
                       │
         ┌─────────────┴──────────────────┐
         │ 读取会话记录 JSONL 文件         │
         │ ~/.claude/sessions/xxx.jsonl   │
         └─────────────┬──────────────────┘
                       │
         ┌─────────────┴──────────────────┐
         │ 提取最后一条 Assistant 回复    │
         │ (tail -r + jq 解析)           │
         └─────────────┬──────────────────┘
                       │
         ┌─────────────┴──────────────────┐
         │ 应用智能过滤规则               │
         │ • 删除 HTTP 错误消息           │
         │ • 删除系统登录消息             │
         │ • 删除过短内容 (<30字符)       │
         │ • 截取最长 1500 字符          │
         └─────────────┬──────────────────┘
                       │
         ┌─────────────┴──────────────────┐
         │ 生成任务完成记录               │
         │ ┌──────────────────────────┐  │
         │ │ 完成时间：2024-01-15 11:05 │ │
         │ │ 执行结果：✅ 成功完成      │  │
         │ │ Claude 总结：[完整回复]    │  │
         │ │ 会话链接：相对路径         │  │
         │ └──────────────────────────┘  │
         └──────┬──────────────────┬─────┘
                │                  │
        ┌──────▼────────┐  ┌─────▼──────────┐
        │更新今日日志   │  │更新项目日志    │
        │(追加完成信息) │  │(追加完成信息)  │
        └──────────────┘  └────────────────┘
                │
                ▼
    ✅ 日志记录完成，任务链接已保存
```

---

### 两个事件的对比

| 事件类型 | UserPromptSubmit | Stop |
|---------|-----------------|------|
| **触发时机** | 用户点击提交 prompt | Claude Code 停止执行 |
| **输入信息** | prompt、session_id、项目信息 | transcript_path、session_id |
| **主要操作** | 创建任务开始记录 | 提取&整理完成结果 |
| **读取文件** | 环境变量、输入 JSON | JSONL 会话记录 |
| **写入操作** | 追加新任务条目 | 追加完成信息到现有任务 |
| **关键数据** | 时间戳、任务描述 | Claude 回复、执行耗时 |
| **用户体验影响** | 低（只记录开始） | 中（自动提取内容） |

---

### 核心实现细节

#### 1. UserPromptSubmit 阶段

```bash
# 脚本触发时执行的操作流程：

# Step 1: 解析输入 JSON
prompt=$(echo "$input_json" | jq -r '.prompt')
session_id=$(echo "$input_json" | jq -r '.session_id')

# Step 2: 识别项目名称（通过目录匹配）
# 示例：~/Projects/red-note → PROJECT_NAME="RedNote"
project_name=$(get_project_name)

# Step 3: 生成时间戳
timestamp=$(date '+%Y-%m-%d %H:%M:%S')

# Step 4: 创建任务记录条目
task_entry="
### 项目：${project_name}

#### 任务 - ${date}
- **开始时间**：${timestamp}
- **会话ID**：${session_id}
- **任务描述**：
\`\`\`
${prompt}
\`\`\`
"

# Step 5: 同时写入两个文件
# 文件1: ~/wonderland/Projects/ClaudeLog/ClaudeCode-Daily/2024-01-15.md
# 文件2: ~/wonderland/Projects/ClaudeLog/RedNote/ClaudeCode-Log.md
```

#### 2. Stop 阶段 —— 智能内容提取

这是最复杂也最有价值的部分。脚本需要从 JSONL 会话记录中智能地提取"有用的信息"。

```bash
# 从 ~/.claude/sessions/xxx.jsonl 读取，这是一个 JSONL 格式的文件
# 每一行都是一个 JSON 对象，表示一条消息

# 关键挑战：最后一条消息可能不是有用的内容
# 示例场景：
# - 最后一条可能是"API Error: 500"
# - 最后一条可能是"Login successful"
# - 最后一条可能是个空消息

# 解决方案：应用多层过滤规则

should_filter_message() {
  local content="$1"
  
  # 规则1: 过短的消息（<30字符）
  if [[ ${#content} -lt 30 ]]; then
    return 0  # 过滤掉
  fi
  
  # 规则2: API/HTTP 错误消息
  if [[ "$content" =~ "API Error" ]]; then
    return 0  # 过滤掉
  fi
  
  # 规则3: 系统消息（登录、命令提示等）
  if [[ "$content" =~ "Please run /login" ]]; then
    return 0  # 过滤掉
  fi
  
  return 1  # 保留这条消息
}

# 执行过程：
# 1. tail -r 反向读取会话文件（从最后往前）
# 2. jq 过滤出 role=assistant 的消息
# 3. 逐条检查，找第一条不被过滤的
# 4. 截取前 1500 字符（防止日志过长）
```

---

## 双维度日志系统的威力

这个系统之所以有效，在于它提供了**两个互补的视角**：

### 维度一：时间轴（ClaudeCode-Daily）

```
ClaudeCode-Daily/
├── 2024-01-15.md  ← 按天组织
├── 2024-01-14.md
└── 2024-01-13.md

# 2024-01-15.md 的结构：
## 📅 日期：2024-01-15

### 项目：RedNote
#### 任务 - 2024-01-15
- 开始时间：10:30:45
- 完成时间：11:05:22
- Claude 总结：[完整内容]

### 项目：Interview
#### 任务 - 2024-01-15
- 开始时间：14:20:10
- 完成时间：15:45:33
- Claude 总结：[完整内容]
```

**用途**：快速了解"今天干了什么"，评估工作效率

---

### 维度二：项目轴（按项目分类）

```
Projects/ClaudeLog/
├── RedNote/
│   └── ClaudeCode-Log.md  ← 该项目的所有任务历史
├── Interview/
│   └── ClaudeCode-Log.md
└── Tech/
    └── ClaudeCode-Log.md

# RedNote/ClaudeCode-Log.md 的结构：
## 📋 任务记录

#### 任务 - 2024-01-15
- 开始时间：10:30:45
- 任务描述：实现用户认证功能
- Claude 总结：[完整内容]

#### 任务 - 2024-01-14
- 开始时间：09:15:20
- 任务描述：修复登录页面样式
- Claude 总结：[完整内容]
```

**用途**：追踪特定项目的所有迭代，遇到 bug 时快速回溯历史

---

## 为什么这个系统有效

回到最初的问题：**暂停点的注意力真空**。

这个脚本系统通过以下方式缓解问题：

### 1. 强制记录机制
每一个任务开始，系统就自动创建记录。这种"写下来"的行为本身就是一种**认知固定**——你的意图被外部化了。即使分心，回来时也有记录可循。

### 2. 完整的上下文链接
通过 session_id，每个任务都与会话记录关联。这意味着你不需要依赖记忆，所有的"为什么做这个"都有案可查。

### 3. 破坏"快速决策"的冲动
知道自己的每个决定都会被记录，会不自觉地让你更谨慎。这正是我们想要的——**让暂停真正成为思考的时刻**。

### 4. 长期反馈循环
一周后，当你回顾这些日志时，会看到哪些决定导致了后续的 bug。这种**延迟反馈**虽然比即时反馈来得慢，但影响力更强。

---

## 额外的收获

当我请求 Claude 修改我的英文草稿时，它不仅完成了我的要求，还提供了深思熟虑的改进建议。这提醒我，工具只是辅助，**其实真正重要的还是自己掌控专注力**。

脚本只是工具。它能做的只是记录和整理。真正的改变来自于：
- 意识到问题的存在
- 主动建立结构来应对这个问题
- 定期审视这些记录，从中学习

---

## 管理注意力的策略

基于这个自动化系统，我总结了几个实践策略：

### 策略 1：物理环境的约束

**在任务执行间**，尽可能让终端 pin 在顶端，抵抗切换注意力的冲动。保持专注于你的终端或编辑器。这不是心理约束，而是**物理上的可见性约束**。看不见诱惑，就更难被诱惑。

### 策略 2：工作的批处理

**将工作分批进行**，进行专注的编码会话，避免其他诱人的标签或应用程序。每个人的大脑注意力资源有限，不应该分散在多个上下文中。一个深度工作的 2 小时，往往比碎片化的 4 小时更有产出。

### 策略 3：主动的认知干预

**主动阅读计划**再进行批准——考虑添加一个有意的 5 秒暂停，确保你理解 Claude 提议做什么。这 5 秒钟的"空白"，是打破自动化决策的关键。在这个空白里，你从"自动模式"回到"思考模式"。

---

## 脚本的本地位置

完整脚本位于：`~/wonderland/claude-code-logger/v2.sh`

### 如何使用

```bash
# 1. 将脚本复制到 Claude Code hooks 目录
cp ~/wonderland/claude-code-logger/v2.sh ~/.claude/hooks/

# 2. 配置环境变量（在你的 shell 配置中）
export CLAUDE_LOGGER_DEBUG=1  # 启用调试日志
export CLAUDE_PROJECT_DIR=/path/to/your/project

# 3. Claude Code 会在自动调用这个脚本
# 当事件触发时（UserPromptSubmit, Stop）
```

### 配置项

脚本顶部有配置区域，可以自定义：

```bash
VAULT_PATH="$HOME/wonderland/eriko-echo"
PROJECTS_DIR="$VAULT_PATH/Projects/ClaudeLog"
DAILY_LOG_DIR="$PROJECTS_DIR/ClaudeCode-Daily"

# 项目名称映射
declare -A PROJECT_MAP=(
  ["red-note"]="RedNote"
  ["a-red-note"]="ARedNote"
  ["tech"]="Tech"
  ["interview"]="Interview"
  ["wonderland-nexus"]="wonderland-nexus"
)
```

---

## 反思与展望

这个系统不是完美的，但它很有效。它提醒我们：

1. **工具不是解决方案本身**，而是帮助我们实施解决方案的助手
2. **系统性的记录**比任何意志力都更可靠
3. **双维度的视角**能捕捉到单一视角遗漏的见解

我希望这个分享能帮助其他也在使用 Claude Code 的开发者。关键不在于你是否会分心，而在于当分心发生时，你有什么机制来应对它。

---

**想了解更多？**

- 完整的脚本代码：[GitHub 链接]
- Obsidian 笔记模板：[下载]
- 更多关于专注力的思考：[博客链接]

欢迎在评论区分享你的想法和经验。
